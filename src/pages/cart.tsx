import Head from "next/head";
import Nav from "@/components/Nav";

import { Input } from "@/components/ui/input";
import { NextPage } from "next";
import { useBoundStore } from "@/zustand/store";
import { Button } from "@/components/ui/button";
import SelectDateButton from "@/components/ui/SelectDateButton";
import { formatPrice } from "@/lib/utils";
import { Equipment } from "@/types/models";
import CartItemCounter from "@/components/CartItemCounter";
import { getDatesInRange, getTotalWorkingDays } from "@/lib/dates";
import { useMemo } from "react";

const CartPage: NextPage = () => {
  const cartItems = useBoundStore((state) => state.cartItems);

  return (
    <>
      <Head>
        <title>Guanaco Rental</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/logo-favicon.ico" />
      </Head>

      <Nav />

      <main className="min-h-screen bg-app-bg px-6 pt-[70px]">
        <section className="mt-12 grid grid-cols-12 gap-8">
          <section className="col-span-8 ">
            <div className="grid grid-cols-12 pb-6">
              <p className="col-span-8">Equipos</p>
              <p className="col-span-2">Cantidad</p>
              <p className="col-span-2">Precio</p>
            </div>
            <ItemsList items={cartItems} />
          </section>
          <RightBar cartItems={cartItems} />
        </section>
      </main>
    </>
  );
};

type ItemsListProps = {
  items: Equipment[];
};

const ItemsList = ({ items }: ItemsListProps) => {
  return (
    <div className="grid gap-8">
      {items?.map((item) => (
        <Item key={item.id} item={item} />
      ))}
    </div>
  );
};

type ItemProps = {
  item: Equipment;
};

const Item = ({ item }: ItemProps) => {
  return (
    <div className="grid grid-cols-12 items-center">
      <p className="col-span-8">
        <strong className="font-extrabold">
          {item.name} {item.brand}
        </strong>{" "}
        <strong className="font-semibold">{item.model}</strong>
      </p>
      <div className="col-span-2">
        <CartItemCounter item={item} />
      </div>
      <p className="col-span-2 text-lg font-semibold">
        {formatPrice(item.price * item.quantity)}
      </p>
    </div>
  );
};

type RightBarProps = {
  cartItems: Equipment[];
};

const RightBar = ({ cartItems }: RightBarProps) => {
  const startDate = useBoundStore((state) => state.startDate);
  const endDate = useBoundStore((state) => state.endDate);
  const location = useBoundStore((state) => state.location);

  const workingDays = useMemo(() => {
    if (startDate && endDate) {
      const datesInRange = getDatesInRange(startDate, endDate);
      return getTotalWorkingDays(datesInRange, "20:00");
    }
    return undefined;
  }, [startDate, endDate]);

  const cartTotal = useMemo(() => {
    const cartSum = cartItems.reduce(
      (acc, curr) => acc + curr.price * curr.quantity,
      0
    );
    if (workingDays) {
      return workingDays * cartSum;
    }
    return 0;
  }, [workingDays, cartItems]);

  return (
    <section className="col-span-4 grid gap-6 ">
      {!startDate || !endDate ? (
        <SelectDateButton />
      ) : (
        <div className="flex justify-between">
          <p>Retiro: {new Date(startDate).toLocaleDateString()}</p>
          <p>Devoluci√≥n: {new Date(endDate).toLocaleDateString()}</p>
        </div>
      )}
      <Button>Continuar Alquilando</Button>

      <textarea
        placeholder="Algo que nos quieras decir?"
        className="p-2 text-sm"
      />

      <div className="grid gap-2">
        <div className="flex items-center justify-between font-semibold">
          <p>Sucursal:</p>
          <p>{location}</p>
        </div>
        <div className="flex items-center justify-between font-semibold">
          <p>Total:</p>
          {!startDate || !endDate ? (
            <p className="flex justify-center">
              Selecciona una fecha para alquilar!
            </p>
          ) : (
            <p className="text-xl font-bold">{formatPrice(cartTotal)}</p>
          )}
        </div>
      </div>

      <div className="grid gap-2">
        <Button disabled={!startDate || !endDate}>Agendar Pedido</Button>
      </div>
    </section>
  );
};

export default CartPage;
