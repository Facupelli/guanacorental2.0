import { type NextPage } from "next";
import Head from "next/head";

import Nav from "@/components/Nav";
import AdminLayout from "@/components/layout/AdminLayout";
import Calendar from "react-calendar";
import { api } from "@/utils/api";
import dayjs from "dayjs";
import { useState } from "react";
import { Prisma } from "@prisma/client";

type Order = Prisma.OrderGetPayload<{
  include: {
    book: true;
  };
}>;

const Admin: NextPage = () => {
  const [calendarValue, setCalendarValue] = useState();
  const [orders, setOrders] = useState<Order[] | null>(null);

  const { data } = api.order.getCalendarOrders.useQuery();

  if (!data) return <div>404</div>;

  const handleClickDay = (day: Date) => {
    const orders = data.filter(
      (order) =>
        dayjs(order.book.start_date).isSame(dayjs(day), "day") ||
        dayjs(order.book.end_date).isSame(dayjs(day), "day")
    );
    setOrders(orders);
  };

  console.log(orders);

  return (
    <>
      <Head>
        <title>Create T3 App</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Nav />

      <main className="">
        <AdminLayout>
          <h1 className="text-lg font-bold">CALENDARIO</h1>
          <div className="pt-6">
            <Calendar
              locale="es-ES"
              minDate={new Date()}
              onClickDay={handleClickDay}
              className="rounded-lg p-4"
              defaultValue={new Date()}
              tileClassName={({ date }: { date: Date }) => {
                if (
                  data.find(
                    (order) =>
                      dayjs(order.book.end_date).isSame(dayjs(date), "day") &&
                      data.find((order) =>
                        dayjs(order.book.start_date).isSame(dayjs(date), "day")
                      )
                  )
                ) {
                  return "pickup-and-return";
                }
                if (
                  data.find((order) =>
                    dayjs(order.book.end_date).isSame(dayjs(date), "day")
                  )
                ) {
                  return "return-day";
                }
                if (
                  data.find((order) =>
                    dayjs(order.book.start_date).isSame(dayjs(date), "day")
                  )
                ) {
                  return "pickup-day";
                }

                return "";
              }}
            />
          </div>
        </AdminLayout>
      </main>
    </>
  );
};

export default Admin;
